<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Clientes Naturales</title>
  <style>
    body { font-family: Arial, sans-serif; background-color: #f9fafb; padding: 20px; }
    h2 { color: #0c2340; margin-bottom: 20px; }
    .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
    .tab { background-color: #0c2340; color: white; padding: 10px 20px; border-radius: 8px; cursor: pointer; transition: 0.3s; }
    .tab.active { background-color: #1b4a80; font-weight: bold; }
    .section { display: none; }
    .section.active { display: block; }
    .toolbar { margin-bottom: 10px; display:flex; gap:8px; align-items:center; }
    table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: left; }
    th { background-color: #0c2340; color: white; }
    .actions button { background-color: #0c2340; color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer; margin-right: 5px; }
    .actions button:hover { background-color: #1b4a80; }
    form { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); max-width: 520px; }
    label { display: block; font-weight: bold; margin-top: 10px; }
    input, select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 6px; margin-top: 5px; }
    button { background-color: #0c2340; color: white; border: none; border-radius: 6px; padding: 10px 15px; margin-top: 15px; cursor: pointer; transition: 0.3s; }
    button:hover { background-color: #123d6a; }
    #msgForm, #msgLista { margin-top: 10px; font-weight: bold; }
    .success { color: green; }
    .error { color: red; }
    .loading { color: #0c2340; font-weight: bold; }
  </style>
</head>
<body>
  <h2>Clientes Naturales</h2>

  <!-- Pesta√±as -->
  <div class="tabs">
    <div class="tab active" id="tab-lista">üìã Lista de usuarios</div>
    <div class="tab" id="tab-crear">‚ûï Crear usuario</div>
  </div>

  <!-- üßæ LISTA DE CLIENTES -->
  <div class="section active" id="lista-section">
    <div class="toolbar">
      <button id="btnRecargar">üîÑ Recargar</button>
      <span id="msgLista" class="loading">Cargando lista de clientes...</span>
    </div>
    <table id="tabla-clientes">
      <thead>
        <tr>
          <th>DNI</th>
          <th>Nombre</th>
          <th>Monto (S/)</th>
          <th>Inicio</th>
          <th>Fin</th>
          <th>Operaciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- üßç CREAR CLIENTE -->
  <div class="section" id="crear-section">
    <form id="crearForm">
      <label for="dni">DNI</label>
      <div style="display:flex;gap:5px;align-items:center;">
        <input type="text" id="dni" maxlength="8" required placeholder="Ej: 12345678" style="flex:1;">
        <button type="button" id="buscarDNI">üîç</button>
      </div>

      <label for="nombre">Nombre completo</label>
      <input type="text" id="nombre" readonly style="background-color:#e9ecef;">

      <label for="nombres">Nombres</label>
      <input type="text" id="nombres" readonly style="background-color:#e9ecef;">

      <label for="apellidoP">Apellido paterno</label>
      <input type="text" id="apellidoP" readonly style="background-color:#e9ecef;">

      <label for="apellidoM">Apellido materno</label>
      <input type="text" id="apellidoM" readonly style="background-color:#e9ecef;">

      <label for="departamento">Departamento</label>
      <input type="text" id="departamento" readonly style="background-color:#e9ecef;">

      <label for="direccionCompleta">Direcci√≥n completa</label>
      <input type="text" id="direccionCompleta" readonly style="background-color:#e9ecef;">

      <label for="dinero">Monto del pr√©stamo (S/)</label>
      <input type="number" id="dinero" min="0" step="0.01" required>

      <label for="fechaInicio">Fecha de inicio</label>
      <input type="date" id="fechaInicio" readonly>

      <label for="plazo">Plazo (pago)</label>
      <select id="plazo" required>
        <option value="">Seleccione...</option>
        <option value="3">3 meses</option>
        <option value="6">6 meses</option>
        <option value="9">9 meses</option>
        <option value="12">12 meses</option>
        <option value="24">24 meses</option>
      </select>

      <label for="fechaFin">Fecha de fin</label>
      <input type="date" id="fechaFin" readonly>

      <button type="submit">üíæ Guardar Cliente</button>
      <p id="msgForm"></p>
    </form>
  </div>

  <script>
    // ========= FECHAS =========
    const fechaInicioInput = document.getElementById('fechaInicio');
    const hoy = new Date();
    const hoyISO = hoy.toISOString().split('T')[0];
    fechaInicioInput.value = hoyISO;

    // FIX: estaba escrito "documet"
    document.getElementById("plazo").addEventListener("change", () => {
      const meses = parseInt(document.getElementById("plazo").value);
      if (!meses) return;
      const base = new Date(); // siempre desde "hoy" actual
      base.setMonth(base.getMonth() + meses);
      document.getElementById("fechaFin").value = base.toISOString().split('T')[0];
    });

    // ========= PESTA√ëAS =========
    const tabLista = document.getElementById('tab-lista');
    const tabCrear = document.getElementById('tab-crear');
    const listaSection = document.getElementById('lista-section');
    const crearSection = document.getElementById('crear-section');

    tabLista.addEventListener('click', () => {
      tabLista.classList.add('active');
      tabCrear.classList.remove('active');
      listaSection.classList.add('active');
      crearSection.classList.remove('active');
      cargarClientes();
    });

    tabCrear.addEventListener('click', () => {
      tabCrear.classList.add('active');
      tabLista.classList.remove('active');
      crearSection.classList.add('active');
      listaSection.classList.remove('active');
    });

    // ========= LISTA DE CLIENTES =========
    async function cargarClientes() {
      const msg = document.getElementById('msgLista');
      const tbody = document.querySelector('#tabla-clientes tbody');
      msg.textContent = "Cargando lista de clientes...";
      msg.className = "loading";

      try {
        const res = await fetch('/api/clientes', { cache: 'no-store' });
        const data = await res.json();

        if (!data.success || !data.clientes || data.clientes.length === 0) {
          msg.textContent = "No hay clientes registrados.";
          msg.className = "error";
          tbody.innerHTML = "";
          return;
        }

        msg.textContent = "";
        tbody.innerHTML = "";
        data.clientes.forEach(c => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${c.dni}</td>
            <td>${c.nombre}</td>
            <td>${Number(c.monto).toFixed(2)}</td>
            <td>${c.fecha_inicio || ''}</td>
            <td>${c.fecha_fin || ''}</td>
            <td class="actions">
              <button data-dni="${c.dni}" class="btn-ver">üëÅÔ∏è</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error(err);
        msg.textContent = "Error al cargar la lista.";
        msg.className = "error";
      }
    }

    document.getElementById('btnRecargar').addEventListener('click', cargarClientes);
    document.addEventListener('DOMContentLoaded', cargarClientes);

    // ========= BUSCAR DNI =========
    const buscarBtn = document.getElementById("buscarDNI");
    const msgForm = document.getElementById("msgForm");

    buscarBtn.addEventListener("click", async () => {
      const dni = document.getElementById("dni").value.trim();
      if (dni.length !== 8) {
        msgForm.textContent = "‚ö†Ô∏è Ingrese un DNI v√°lido de 8 d√≠gitos.";
        msgForm.className = "error";
        return;
      }

      msgForm.textContent = "üîÑ Consultando Factiliza...";
      msgForm.className = "loading";

      try {
        const res = await fetch("/api/reniec", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ dni }),
        });
        const data = await res.json();

        if (data.success && data.data) {
          const d = data.data;
          document.getElementById("nombre").value = d.nombre_completo || "";
          document.getElementById("nombres").value = d.nombres || "";
          document.getElementById("apellidoP").value = d.apellido_paterno || "";
          document.getElementById("apellidoM").value = d.apellido_materno || "";
          document.getElementById("departamento").value = d.departamento || "";
          document.getElementById("direccionCompleta").value = d.direccion_completa || "";
          msgForm.textContent = "‚úÖ Persona encontrada.";
          msgForm.className = "success";
        } else {
          msgForm.textContent = "‚ùå No se encontr√≥ el DNI.";
          msgForm.className = "error";
        }
      } catch (err) {
        msgForm.textContent = "‚ùå Error al consultar Factiliza.";
        msgForm.className = "error";
      }
    });

    // ========= GUARDAR CLIENTE =========
    document.getElementById("crearForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      if (!confirm("¬øDesea registrar este pr√©stamo y descontar el monto del fondo?")) return;

      msgForm.textContent = "Guardando cliente...";
      msgForm.className = "loading";

      const body = {
        dni: document.getElementById("dni").value.trim(),
        nombre: document.getElementById("nombre").value.trim(),
        nombres: document.getElementById("nombres").value.trim(),
        apellido_paterno: document.getElementById("apellidoP").value.trim(),
        apellido_materno: document.getElementById("apellidoM").value.trim(),
        departamento: document.getElementById("departamento").value.trim(),
        direccion: document.getElementById("direccionCompleta").value.trim(),
        monto: parseFloat(document.getElementById("dinero").value),
        fecha_inicio: document.getElementById("fechaInicio").value,
        fecha_fin: document.getElementById("fechaFin").value
      };

      try {
        const res = await fetch("/api/clientes", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });
        const data = await res.json();

        msgForm.textContent = data.message;
        msgForm.className = data.success ? "success" : "error";
        if (data.success) {
          document.getElementById("crearForm").reset();
          // re-autocompletar fecha de inicio y limpiar fin
          fechaInicioInput.value = hoyISO;
          document.getElementById("fechaFin").value = "";
          cargarClientes(); // refrescar lista sin perder datos
        }
      } catch (err) {
        msgForm.textContent = "‚ùå Error al guardar el cliente.";
        msgForm.className = "error";
      }
    });
  </script>
</body>
</html>
