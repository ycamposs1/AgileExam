<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Clientes Naturales</title>
  <style>
    body { font-family: Arial, sans-serif; background-color: #f9fafb; padding: 20px; }
    h2 { color: #0c2340; margin-bottom: 20px; }
    .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
    .tab { background-color: #0c2340; color: white; padding: 10px 20px; border-radius: 8px; cursor: pointer; transition: 0.3s; }
    .tab.active { background-color: #1b4a80; font-weight: bold; }
    .section { display: none; }
    .section.active { display: block; }
    .toolbar { margin-bottom: 10px; display:flex; gap:8px; align-items:center; }
    table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: left; }
    th { background-color: #0c2340; color: white; }
    .actions button { background-color: #0c2340; color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer; margin-right: 5px; }
    .actions button:hover { background-color: #1b4a80; }
    form { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); max-width: 520px; }
    label { display: block; font-weight: bold; margin-top: 10px; }
    input, select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 6px; margin-top: 5px; }
    button { background-color: #0c2340; color: white; border: none; border-radius: 6px; padding: 10px 15px; margin-top: 15px; cursor: pointer; transition: 0.3s; }
    button:hover { background-color: #123d6a; }
    #msgForm, #msgLista { margin-top: 10px; font-weight: bold; }
    .success { color: green; }
    .error { color: red; }
    .loading { color: #0c2340; font-weight: bold; }
  </style>
</head>
<body>
  <h2>Clientes Naturales</h2>

  <!-- Pesta√±as -->
  <div class="tabs">
    <div class="tab active" id="tab-lista">üìã Lista de usuarios</div>
    <div class="tab" id="tab-crear">‚ûï Crear cliente</div>
  </div>

  <!-- üßæ LISTA DE CLIENTES -->
  <div class="section active" id="lista-section">
    <div class="toolbar">
      <button id="btnRecargar">üîÑ Recargar</button>
      <span id="msgLista" class="loading">Cargando lista de clientes...</span>
    </div>
    <table id="tabla-clientes">
      <thead>
        <tr>
          <th>DNI</th>
          <th>Nombre</th>
          <th>Monto (S/)</th>
          <th>Inicio</th>
          <th>Fin</th>
          <th>Operaciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- üßç CREAR CLIENTE -->
  <div class="section" id="crear-section">
    <form id="crearForm">
      <label for="dni">DNI</label>
      <div style="display:flex;gap:5px;align-items:center;">
        <input type="text" id="dni" maxlength="8" required placeholder="Ej: 12345678" style="flex:1;">
        <button type="button" id="buscarDNI">üîç</button>
      </div>

      <label for="nombre">Nombre completo</label>
      <input type="text" id="nombre" readonly style="background-color:#e9ecef;">

      <label for="nombres">Nombres</label>
      <input type="text" id="nombres" readonly style="background-color:#e9ecef;">

      <label for="apellidoP">Apellido paterno</label>
      <input type="text" id="apellidoP" readonly style="background-color:#e9ecef;">

      <label for="apellidoM">Apellido materno</label>
      <input type="text" id="apellidoM" readonly style="background-color:#e9ecef;">

      <label for="departamento">Departamento</label>
      <input type="text" id="departamento" readonly style="background-color:#e9ecef;">

      <label for="direccionCompleta">Direcci√≥n completa</label>
      <input type="text" id="direccionCompleta" readonly style="background-color:#e9ecef;">

      <label for="email">Correo electr√≥nico</label>
      <input type="email" id="email" required placeholder="Ej: cliente@correo.com">

      <label for="dinero">Monto del pr√©stamo (S/)</label>
      <input type="number" id="dinero" min="0" step="0.01" required>

      <!-- üîπ Tipo de pr√©stamo -->
      <label for="tipoPrestamo">Tipo de pr√©stamo</label>
        <select id="tipoPrestamo" required>
          <option value="">Seleccione...</option>
          <option value="personal">Personal</option>
          <option value="vehicular">Vehicular</option>
          <option value="hipotecario">Hipotecario</option>
          <option value="educativo">Educativo</option>
        </select>

      <!-- üîπ Selecci√≥n de TCEA -->
      <label for="tceaSelect">TCEA (%)</label>
        <select id="tceaSelect" required>
          <option value="">Seleccione tipo de pr√©stamo primero</option>
        </select>

      <!-- Campo TCEA manual -->
      <div id="tceaManualContainer" style="display:none;">
        <label for="tceaManual">TCEA personalizada (%)</label>
        <input type="number" id="tceaManual" min="0" max="200" step="0.01" placeholder="Ej: 18.5">
      </div>


      <label for="fechaInicio">Fecha de inicio</label>
      <input type="date" id="fechaInicio" readonly>

      <label for="plazo">Plazo (pago)</label>
        <select id="plazo" required>
          <option value="">Seleccione...</option>
          <option value="3">3 meses</option>
          <option value="6">6 meses</option>
          <option value="9">9 meses</option>
          <option value="12">12 meses</option>
          <option value="24">24 meses</option>
        </select>

      <label for="fechaFin">Fecha de fin</label>
      <input type="date" id="fechaFin" readonly>

      <button type="submit">üíæ Guardar Cliente</button>
      <p id="msgForm"></p>
    </form>
  </div>


<!-- Modal de Detalle -->
<div id="modal" style="
  display:none;
  position:fixed;
  top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.5);
  justify-content:center;
  align-items:center;
">
  <div style="background:white;padding:20px;border-radius:8px;max-width:400px;width:90%;">
    <h3>Detalles del Cliente</h3>
    <div id="detalleCliente"></div>
    <button id="btnEliminar" style="background:red;color:white;padding:6px 12px;border:none;border-radius:6px;">üóëÔ∏è Eliminar</button>
    <button onclick="cerrarModal()">Cerrar</button>
  </div>
</div>

  <script>
    // ========= FECHAS =========
    const fechaInicioInput = document.getElementById('fechaInicio');
    const hoy = new Date();
    const hoyISO = hoy.toISOString().split('T')[0];
    fechaInicioInput.value = hoyISO;

    // FIX: estaba escrito "documet"
    document.getElementById("plazo").addEventListener("change", () => {
      const meses = parseInt(document.getElementById("plazo").value);
      if (!meses) return;
      const base = new Date(); // siempre desde "hoy" actual
      base.setMonth(base.getMonth() + meses);
      document.getElementById("fechaFin").value = base.toISOString().split('T')[0];
    });

    // ========= PESTA√ëAS =========
    const tabLista = document.getElementById('tab-lista');
    const tabCrear = document.getElementById('tab-crear');
    const listaSection = document.getElementById('lista-section');
    const crearSection = document.getElementById('crear-section');

    tabLista.addEventListener('click', () => {
      tabLista.classList.add('active');
      tabCrear.classList.remove('active');
      listaSection.classList.add('active');
      crearSection.classList.remove('active');
      cargarClientes();
    });

    tabCrear.addEventListener('click', () => {
      tabCrear.classList.add('active');
      tabLista.classList.remove('active');
      crearSection.classList.add('active');
      listaSection.classList.remove('active');
    });

    // ========= LISTA DE CLIENTES =========
    async function cargarClientes() {
      const msg = document.getElementById('msgLista');
      const tbody = document.querySelector('#tabla-clientes tbody');
      msg.textContent = "Cargando lista de clientes...";
      msg.className = "loading";

      try {
        const res = await fetch('/api/clientes', { cache: 'no-store' });
        const data = await res.json();

        if (!data.success || !data.clientes || data.clientes.length === 0) {
          msg.textContent = "No hay clientes registrados.";
          msg.className = "error";
          tbody.innerHTML = "";
          return;
        }

        msg.textContent = "";
        tbody.innerHTML = "";
        data.clientes.forEach(c => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${c.dni}</td>
            <td>${c.nombre}</td>
            <td>${Number(c.monto).toFixed(2)}</td>
            <td>${c.fecha_inicio || ''}</td>
            <td>${c.fecha_fin || ''}</td>
            <td class="actions">
              <button onclick="verDetalle('${c.dni}')">üëÅÔ∏è Ver</button>
            </td>


          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error(err);
        msg.textContent = "Error al cargar la lista.";
        msg.className = "error";
      }
    }

    document.getElementById('btnRecargar').addEventListener('click', cargarClientes);
    document.addEventListener('DOMContentLoaded', cargarClientes);

    // ========= BUSCAR DNI =========
    const buscarBtn = document.getElementById("buscarDNI");
    const msgForm = document.getElementById("msgForm");

    buscarBtn.addEventListener("click", async () => {
      const dni = document.getElementById("dni").value.trim();
      if (dni.length !== 8) {
        msgForm.textContent = "‚ö†Ô∏è Ingrese un DNI v√°lido de 8 d√≠gitos.";
        msgForm.className = "error";
        return;
      }

      msgForm.textContent = "üîÑ Consultando Factiliza...";
      msgForm.className = "loading";

      try {
        const res = await fetch("/api/reniec", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ dni }),
        });
        const data = await res.json();

        if (data.success && data.data) {
          const d = data.data;
          document.getElementById("nombre").value = d.nombre_completo || "";
          document.getElementById("nombres").value = d.nombres || "";
          document.getElementById("apellidoP").value = d.apellido_paterno || "";
          document.getElementById("apellidoM").value = d.apellido_materno || "";
          document.getElementById("departamento").value = d.departamento || "";
          document.getElementById("direccionCompleta").value = d.direccion_completa || "";
          msgForm.textContent = "‚úÖ Persona encontrada.";
          msgForm.className = "success";
        } else {
          msgForm.textContent = "‚ùå No se encontr√≥ el DNI.";
          msgForm.className = "error";
        }
      } catch (err) {
        msgForm.textContent = "‚ùå Error al consultar Factiliza.";
        msgForm.className = "error";
      }
    });

    // ========= GUARDAR CLIENTE =========
    document.getElementById("crearForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      if (!confirm("¬øDesea registrar este pr√©stamo y descontar el monto del fondo?")) return;

      msgForm.textContent = "Guardando cliente...";
      msgForm.className = "loading";

      // Obtener TCEA elegida
      let tceaAplicada = parseFloat(tceaSelect.value);
      if (tceaSelect.value === "manual") {
        const manual = parseFloat(tceaManual.value);
        if (isNaN(manual) || manual <= 0 || manual > 200) {
          alert("Ingrese una TCEA v√°lida (0% - 200%)");
          return;
        }
        tceaAplicada = manual / 100; // convertir de porcentaje a decimal
      } else {
        tceaAplicada = tceaAplicada; // ya viene en decimal
      }
      const body = {
        dni: document.getElementById("dni").value.trim(),
        email: document.getElementById("email").value.trim(),
        nombre: document.getElementById("nombre").value.trim(),
        nombres: document.getElementById("nombres").value.trim(),
        apellido_paterno: document.getElementById("apellidoP").value.trim(),
        apellido_materno: document.getElementById("apellidoM").value.trim(),
        departamento: document.getElementById("departamento").value.trim(),
        direccion: document.getElementById("direccionCompleta").value.trim(),
        monto: parseFloat(document.getElementById("dinero").value),
        plazo: parseInt(document.getElementById("plazo").value),
        tipo_prestamo: document.getElementById("tipoPrestamo").value,
        tcea_aplicada: (tceaSelect.value === "manual"
          ? parseFloat(tceaManual.value) / 100
          : parseFloat(tceaSelect.value)),
        fecha_inicio: document.getElementById("fechaInicio").value,
        fecha_fin: document.getElementById("fechaFin").value
      };



      try {
        const res = await fetch("/api/clientes", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });
        const data = await res.json();

        msgForm.textContent = data.message;
        msgForm.className = data.success ? "success" : "error";
        if (data.success) {
          document.getElementById("crearForm").reset();
          // re-autocompletar fecha de inicio y limpiar fin
          fechaInicioInput.value = hoyISO;
          document.getElementById("fechaFin").value = "";
          cargarClientes(); // refrescar lista sin perder datos
        }
      } catch (err) {
        msgForm.textContent = "‚ùå Error al guardar el cliente.";
        msgForm.className = "error";
      }
    });
    
// ========= VER DETALLE =========
async function verDetalle(dni) {
  const modal = document.getElementById("modal");
  const detalleDiv = document.getElementById("detalleCliente");

  try {
    const res = await fetch(`/api/clientes/${dni}`);
    const data = await res.json();

    if (!data.success || !data.cliente) {
      detalleDiv.innerHTML = "<p style='color:red;'>‚ùå Cliente no encontrado.</p>";
    } else {
      const c = data.cliente;
      detalleDiv.innerHTML = `
        <p><strong>DNI:</strong> ${c.dni}</p>
        <p><strong>Nombre completo:</strong> ${c.nombre}</p>
        <p><strong>Nombres:</strong> ${c.nombres || "-"}</p>
        <p><strong>Apellido Paterno:</strong> ${c.apellido_paterno || "-"}</p>
        <p><strong>Apellido Materno:</strong> ${c.apellido_materno || "-"}</p>
        <p><strong>Departamento:</strong> ${c.departamento || "-"}</p>
        <p><strong>Direcci√≥n:</strong> ${c.direccion || "-"}</p>
        <p><strong>Correo electr√≥nico:</strong> ${c.email || "-"}</p>
        <p><strong>Monto:</strong> S/ ${Number(c.monto).toFixed(2)}</p>
        <p><strong>Fecha inicio:</strong> ${c.fecha_inicio || "-"}</p>
        <p><strong>Fecha fin:</strong> ${c.fecha_fin || "-"}</p>
      `;

      // üëâ Guardar el DNI directamente en el bot√≥n
      document.getElementById("btnEliminar").dataset.dni = c.dni;
    }

    modal.style.display = "flex";
  } catch (err) {
    console.error("Error al obtener detalle:", err);
    detalleDiv.innerHTML = "<p style='color:red;'>‚ùå Error al obtener datos del cliente.</p>";
    modal.style.display = "flex";
  }
}


// ========= ELIMINAR CLIENTE =========
document.getElementById("btnEliminar").addEventListener("click", async () => {
  const btn = document.getElementById("btnEliminar");
  const dni = btn.dataset.dni;

  if (!dni) {
    alert("No se pudo obtener el DNI del cliente.");
    return;
  }

  if (!confirm("‚ö†Ô∏è ¬øDesea eliminar este cliente y reintegrar el monto al fondo?")) return;

  try {
    const res = await fetch(`/api/clientes/${dni}`, { method: "DELETE" });
    const data = await res.json();

    alert(data.message);

    if (data.success) {
      cerrarModal();
      cargarClientes(); // refresca la lista
      // üîÅ refresca el navbar (fondos)
      if (window.parent && window.parent.postMessage) {
        window.parent.postMessage({ type: "refreshNavbar" }, "*");
      }
    }
  } catch (err) {
    console.error("Error al eliminar:", err);
    alert("‚ùå Error al eliminar cliente.");
  }
});

// ========= CONFIGURACI√ìN DE TIPO DE PR√âSTAMO Y TCEA =========
const tipoPrestamoSelect = document.getElementById("tipoPrestamo");
const tceaSelect = document.getElementById("tceaSelect");
const tceaManualContainer = document.getElementById("tceaManualContainer");
const tceaManual = document.getElementById("tceaManual");

// Tabla base de TCEA seg√∫n tipo de pr√©stamo
const tiposTCEA = {
  personal: 0.26,
  vehicular: 0.15,
  hipotecario: 0.102,
  educativo: 0.168
};

// Cada vez que cambia el tipo de pr√©stamo
tipoPrestamoSelect.addEventListener("change", () => {
  const tipo = tipoPrestamoSelect.value;
  tceaSelect.innerHTML = "";

  if (!tipo) {
    tceaSelect.innerHTML = "<option value=''>Seleccione tipo de pr√©stamo primero</option>";
    return;
  }

  const base = tiposTCEA[tipo];
  const opciones = [
    (base * 0.9).toFixed(3),  // -10%
    base.toFixed(3),          // base
    (base * 1.1).toFixed(3),  // +10%
    "manual"
  ];

  tceaSelect.innerHTML = `
    <option value="">Seleccione una opci√≥n</option>
    <option value="${opciones[0]}">${(opciones[0]*100).toFixed(1)}% (TCEA baja recomendada)</option>
    <option value="${opciones[1]}">${(opciones[1]*100).toFixed(1)}% (TCEA est√°ndar)</option>
    <option value="${opciones[2]}">${(opciones[2]*100).toFixed(1)}% (TCEA alta recomendada)</option>
    <option value="manual">Ingresar TCEA personalizada</option>
  `;

  tceaManualContainer.style.display = "none";
  tceaManual.value = "";
});

// Mostrar campo manual si elige "personalizada"
tceaSelect.addEventListener("change", () => {
  if (tceaSelect.value === "manual") {
    tceaManualContainer.style.display = "block";
  } else {
    tceaManualContainer.style.display = "none";
    tceaManual.value = "";
  }
});



function cerrarModal() {
  document.getElementById("modal").style.display = "none"; //OCULTAR MODAL SI SALE ERROR CAMBIAR ORDEN Y PONER AL FINAL
}


  </script>

</body>
</html>